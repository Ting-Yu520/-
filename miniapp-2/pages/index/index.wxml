<!-- pages/index/index.wxml -->
<view class="index-container">
  <!-- éª¨æ¶å± -->
  <view wx:if="{{isLoadingTasks && todayTasks.length === 0}}">
    <skeleton></skeleton>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:if="{{!isLoadingTasks || todayTasks.length > 0}}" class="index-content">
    <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <view class="network-status {{isOnline ? 'online' : ''}} {{!isOnline ? 'show' : ''}}">
      <text>{{isOnline ? 'ç½‘ç»œå·²æ¢å¤' : 'ç½‘ç»œè¿æ¥å·²æ–­å¼€'}}</text>
    </view>

    <!-- ç¼“å­˜çŠ¶æ€æç¤º -->
    <view wx:if="{{isUsingCachedData}}" class="cache-indicator content-module">
      <text class="cache-text">æ­£åœ¨ä½¿ç”¨ç¼“å­˜æ•°æ®</text>
      <view class="cache-action" bindtap="refreshTasks">ç‚¹å‡»åˆ·æ–°æœ€æ–°æ•°æ®</view>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <view wx:if="{{hasError}}" class="error-state content-module">
      <view class="error-icon">âš ï¸</view>
      <text class="error-text">åŠ è½½å¤±è´¥</text>
      <text class="error-desc">{{errorMessage}}</text>
      <view class="error-actions">
        <view class="retry-btn" bindtap="retryLoad">é‡è¯•</view>
        <view wx:if="{{!isUsingCachedData}}" class="use-cache-btn" bindtap="useCachedData">ä½¿ç”¨ç¼“å­˜</view>
      </view>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ - ç»Ÿä¸€è“è‰²èƒŒæ™¯ -->
    <view class="user-section content-module">
      <view wx:if="{{isLoggedIn && userInfo.nickName}}" class="user-info-main">
        <view class="user-avatar">
          <text class="avatar-text">{{userInfo.nickName ? userInfo.nickName[0] : 'ç”¨'}}</text>
        </view>
        <view class="user-details">
          <text class="user-name">{{userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
          <text class="today-date">{{todayDate}}</text>
        </view>
        <view class="user-stats">
          <text class="stats-number">{{completedCount}}/{{totalCount}}</text>
          <text class="stats-label">ä»Šæ—¥å®Œæˆ</text>
        </view>
      </view>
      <view wx:else class="login-prompt">
        <view class="login-info">
          <text class="login-title">ç‚¹å‡»ç™»å½•</text>
          <text class="login-subtitle">å¼€å§‹è§„åˆ’ä½ çš„æ—¥ç¨‹</text>
        </view>
        <button class="login-button" bindtap="handleLogin">ç«‹å³ç™»å½•</button>
      </view>
    </view>

    <!-- ä»»åŠ¡åˆ—è¡¨ - ç»Ÿä¸€å®½åº¦è®¾è®¡ -->
    <view class="tasks-section">
      <view class="task-list content-module">
        <view 
          wx:for="{{todayTasks}}" 
          wx:key="_id" 
          class="task-item {{item.status === 'done' ? 'completed' : ''}}"
          data-task="{{item}}"
          bindtap="goToTaskDetail"
        >
          <view class="task-checkbox {{item.status === 'done' ? 'checked' : ''}}" data-task="{{item}}" bindtap="markTaskDone" catchtap>
            <view class="checkbox-icon"></view>
          </view>
          
          <view class="task-content">
            <view class="task-header">
              <text class="task-title {{item.status === 'done' ? 'completed' : ''}}">
                {{item.title}}
              </text>
              <view class="task-meta">
                <text class="task-duration">{{item.duration}}åˆ†é’Ÿ</text>
                <view class="priority-badge priority-{{item.priority}}">
                  P{{item.priority}}
                </view>
              </view>
            </view>
            
            <view class="task-footer">
              <view class="time-range">
                <text class="start-time">{{item.scheduled_start}}</text>
                <text class="time-separator">-</text>
                <text class="end-time">{{item.scheduled_end}}</text>
              </view>
              <view class="task-actions">
                <view 
                  class="action-btn chat-btn" 
                  data-taskid="{{item._id}}" 
                  bindtap="goToChat"
                  catchtap
                >
                  <text class="btn-icon">ğŸ’¬</text>
                  <text class="btn-text">åè°ƒ</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{todayTasks.length === 0 && isLoggedIn && !isLoadingTasks && !hasError}}" class="empty-state content-module">
      <view class="empty-content">
        <text class="empty-emoji">ğŸ“…</text>
        <text class="empty-title">ä»Šæ—¥æš‚æ— ä»»åŠ¡</text>
        <text class="empty-desc">æ·»åŠ ä»»åŠ¡å¼€å§‹è§„åˆ’ä½ çš„ä¸€å¤©</text>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more-section">
      <view wx:if="{{hasMoreTasks}}" class="load-more content-module {{isLoadingMore ? 'loading' : ''}}" bindtap="loadMoreTasks">
        <view class="load-content">
          <view class="loading-dots">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
          <text>{{isLoadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
        </view>
      </view>
      <view wx:else class="no-more content-module">
        <text>æ²¡æœ‰æ›´å¤šä»»åŠ¡äº†</text>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  - ç»Ÿä¸€å®½åº¦è®¾è®¡ -->
    <view class="bottom-actions bottom-action-bar">
      <button class="action-btn primary" bindtap="goToAddTask">
        <text class="btn-icon">+</text>
        <text>æ·»åŠ ä»»åŠ¡</text>
      </button>
      <button class="action-btn secondary" bindtap="goToStats">
        <text class="btn-icon">ğŸ“Š</text>
        <text>æ•°æ®ç»Ÿè®¡</text>
      </button>
    </view>
  </view>
</view>