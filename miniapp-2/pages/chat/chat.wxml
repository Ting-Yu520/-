<!-- pages/chat/chat.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨å›ºå®šåŒºåŸŸ -->
  <view class="top-section">
    <!-- ä»»åŠ¡ä¿¡æ¯ -->
    <view class="task-header">
      <view class="task-info">
        <text class="task-title">{{taskData.title}}</text>
        <text class="task-meta">{{taskData.duration}}åˆ†é’Ÿ Â· ä¼˜å…ˆçº§{{taskData.priority}} Â· {{taskData.date}}</text>
      </view>
      <view class="ai-status">
        <text class="status-text">AIåŠ©ç†åœ¨çº¿</text>
        <view class="status-dot"></view>
      </view>
    </view>

    <!-- AIæ—¥ç¨‹é¢„è§ˆ -->
    <view class="schedule-preview" wx:if="{{schedule.scheduled_start}}">
      <view class="preview-content">
        <view class="preview-header">
          <text class="preview-title">ğŸ“… AIä¸ºæ‚¨å®‰æ’çš„æ—¥ç¨‹</text>
          <text class="preview-time">{{schedule.scheduled_start}} - {{schedule.scheduled_end}}</text>
        </view>
        <view class="preview-actions">
          <button class="btn-accept" bindtap="acceptSchedule">æ¥å—å®‰æ’</button>
          <button class="btn-adjust" bindtap="showAdjustOptions">è°ƒæ•´æ—¶é—´</button>
        </view>
      </view>
    </view>

    <!-- ç½‘ç»œé”™è¯¯æç¤º -->
    <view class="network-error" wx:if="{{hasNetworkError}}">
      <text class="error-text">ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°AIåŠ©æ‰‹</text>
      <button class="retry-btn" bindtap="retryLoadData">é‡è¯•</button>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ - å æ®ä¸»è¦ç©ºé—´ -->
  <view class="chat-section">
    <scroll-view class="chat-messages" scroll-y scroll-with-animation scroll-top="{{scrollTop}}">
      <block wx:for="{{messages}}" wx:key="id">
        <!-- AIæ¶ˆæ¯ -->
        <view class="message ai-message" wx:if="{{item.role === 'ai'}}">
          <view class="avatar ai-avatar">AI</view>
          <view class="message-content">
            <text class="message-text">{{item.content}}</text>
            <text class="message-time">{{item.time}}</text>
          </view>
        </view>

        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view class="message user-message" wx:if="{{item.role === 'user'}}">
          <view class="message-content">
            <text class="message-text">{{item.content}}</text>
            <text class="message-time">{{item.time}}</text>
          </view>
          <view class="avatar user-avatar">{{userInfo.nickName ? userInfo.nickName[0] : 'ç”¨'}}</view>
        </view>

        <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
        <view class="message system-message" wx:if="{{item.role === 'system'}}">
          <text class="system-text">{{item.content}}</text>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-message" wx:if="{{messages.length === 0}}">
        å¼€å§‹ä¸AIåŠ©ç†å¯¹è¯...
      </view>

      <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
      <view class="loading-indicator" wx:if="{{isAIThinking}}">
        <view class="typing-dots">
          <text>AIæ­£åœ¨æ€è€ƒ</text>
          <view class="dots">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨å›ºå®šåŒºåŸŸ -->
  <view class="bottom-section">
    <!-- å¿«æ·è°ƒæ•´é€‰é¡¹ -->
    <view class="quick-actions" wx:if="{{showQuickActions}}">
      <view class="action-buttons">
        <button class="quick-btn" bindtap="sendQuickMessage" data-message="æŠŠä»»åŠ¡å®‰æ’åˆ°ä¸Šåˆ">ä¸Šåˆ</button>
        <button class="quick-btn" bindtap="sendQuickMessage" data-message="æŠŠä»»åŠ¡å®‰æ’åˆ°ä¸‹åˆ">ä¸‹åˆ</button>
        <button class="quick-btn" bindtap="sendQuickMessage" data-message="æŠŠä»»åŠ¡æ—¶é—´ç¼©çŸ­ä¸€äº›">ç¼©çŸ­æ—¶é—´</button>
        <button class="quick-btn" bindtap="sendQuickMessage" data-message="æŠŠä»»åŠ¡æ—¶é—´å»¶é•¿ä¸€äº›">å»¶é•¿æ—¶é—´</button>
      </view>
    </view>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <view class="input-area">
      <view class="input-container">
        <input 
          class="message-input" 
          placeholder="å‘Šè¯‰AIæ‚¨çš„è°ƒæ•´éœ€æ±‚..." 
          value="{{inputMessage}}"
          bindinput="onInput"
          bindconfirm="sendMessage"
          focus="{{autoFocus}}"
        />
        <button class="send-btn" bindtap="sendMessage" disabled="{{!inputMessage.trim()}}">
          <text class="send-icon">â†‘</text>
        </button>
      </view>
    </view>
  </view>
</view>