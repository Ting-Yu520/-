<!-- pages/plan/plan.wxml -->
<view class="container">
  <!-- å®½åº¦å¯¹é½çš„æ—¥æœŸé€‰æ‹©å™¨ -->
  <view class="aligned-date-section">
    <view class="date-picker-aligned">
      <view class="date-nav-aligned">
        <view class="nav-btn-aligned" bindtap="goToPreviousDay">
          <text class="nav-icon-aligned">â€¹</text>
        </view>
        
        <picker mode="date" value="{{currentDate}}" bindchange="onDateChange">
          <view class="date-display-aligned">
            <text class="date-main-aligned">{{formattedDate}}</text>
            <text class="date-week-aligned">{{weekday}}</text>
            <text class="date-tag-aligned">{{isToday ? 'ä»Šå¤©' : isTomorrow ? 'æ˜å¤©' : ''}}</text>
          </view>
        </picker>
        
        <view class="nav-btn-aligned" bindtap="goToNextDay">
          <text class="nav-icon-aligned">â€º</text>
        </view>
      </view>
      
      <view class="quick-actions-aligned">
        <view class="quick-action-aligned {{isToday ? 'active' : ''}}" bindtap="goToToday">
          <text>ä»Šå¤©</text>
        </view>
        <view class="quick-action-aligned {{isTomorrow ? 'active' : ''}}" bindtap="goToTomorrow">
          <text>æ˜å¤©</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®½åº¦å¯¹é½çš„æ—¥ç¨‹æ¦‚è§ˆ -->
  <view class="aligned-stats-section">
    <view class="stats-grid-aligned">
      <view class="stat-item-aligned">
        <text class="stat-number-aligned">{{totalTasks}}</text>
        <text class="stat-label-aligned">æ€»ä»»åŠ¡</text>
      </view>
      <view class="stat-item-aligned">
        <text class="stat-number-aligned">{{completedTasks}}</text>
        <text class="stat-label-aligned">å·²å®Œæˆ</text>
      </view>
      <view class="stat-item-aligned">
        <text class="stat-number-aligned">{{totalDuration}}</text>
        <text class="stat-label-aligned">æ€»æ—¶é•¿</text>
      </view>
      <view class="stat-item-aligned">
        <text class="stat-number-aligned">{{completionRate}}%</text>
        <text class="stat-label-aligned">å®Œæˆç‡</text>
      </view>
    </view>
  </view>

  <!-- æ—¶é—´çº¿æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰ -->
  <view class="aligned-timeline-section">
    <view class="timeline-header-aligned">
      <text class="timeline-title-aligned">æ—¶é—´çº¿</text>
      <button class="ai-optimize-btn-aligned" bindtap="generateAISchedule">
        <text class="ai-icon-aligned">ğŸ¤–</text>
        <text>AIä¼˜åŒ–</text>
      </button>
    </view>

    <view class="timeline-content-aligned">
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{schedule.length === 0 || totalTasks === 0}}" class="empty-state-aligned">
        <view class="empty-content-aligned">
          <text class="empty-icon-aligned">ğŸ“…</text>
          <text class="empty-title-aligned">ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’</text>
          <text class="empty-desc-aligned">æ·»åŠ ä»»åŠ¡åï¼ŒAIä¼šå¸®æ‚¨ç”Ÿæˆåˆç†çš„æ—¥ç¨‹å®‰æ’</text>
          <button class="add-first-btn-aligned" bindtap="goToAddTask">æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡</button>
        </view>
      </view>

      <!-- æ—¶é—´çº¿å†…å®¹ -->
      <view wx:else class="timeline-aligned">
        <block wx:for="{{schedule}}" wx:key="timeSlot" wx:for-index="slotIndex">
          <view class="time-slot-aligned">
            <!-- æ—¶é—´æ ‡è®° -->
            <view class="time-marker-aligned">
              <text class="time-text-aligned">{{item.timeSlot}}</text>
            </view>
            
            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <view class="tasks-container-aligned">
              <block wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id">
                <view class="task-card-aligned status-{{task.status}}" bindtap="goToTaskDetail" data-taskid="{{task._id}}">
                  <view class="task-time-info-aligned">
                    <text class="time-range-aligned">{{task.scheduled_start}} - {{task.scheduled_end}}</text>
                    <text class="duration-aligned">{{task.duration}}åˆ†é’Ÿ</text>
                  </view>
                  
                  <view class="task-content-aligned">
                    <view class="task-header-aligned">
                      <text class="task-title-aligned">{{task.title}}</text>
                      <view class="priority-badge-aligned priority-{{task.priority}}">
                        P{{task.priority}}
                      </view>
                    </view>
                    
                    <view class="task-actions-aligned">
                      <button 
                        class="action-btn-aligned complete {{task.status === 'done' ? 'completed' : ''}}" 
                        bindtap="toggleTaskStatus" 
                        data-taskid="{{task._id}}"
                        data-status="{{task.status}}"
                        catchtap=""
                      >
                        {{task.status === 'done' ? 'âœ“ å·²å®Œæˆ' : 'æ ‡è®°å®Œæˆ'}}
                      </button>
                      
                      <button class="action-btn-aligned adjust" bindtap="adjustTask" data-taskid="{{task._id}}" catchtap="">
                        è°ƒæ•´
                      </button>
                    </view>
                  </view>
                </view>
              </block>
              
              <!-- ç©ºé—²æ—¶é—´ -->
              <view wx:if="{{item.tasks.length === 0 && slotIndex > 0}}" class="free-time-aligned">
                <view class="free-time-content-aligned">
                  <text class="free-icon-aligned">â³</text>
                  <text class="free-text-aligned">ç©ºé—²æ—¶é—´</text>
                  <text class="free-duration-aligned">{{calculateFreeTime(item.timeSlot, slotIndex)}}åˆ†é’Ÿ</text>
                </view>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar-aligned">
    <button class="add-task-btn-aligned" bindtap="goToAddTask">
      <text class="add-icon-aligned">+</text>
      <text>æ·»åŠ ä»»åŠ¡</text>
    </button>
  </view>
</view>