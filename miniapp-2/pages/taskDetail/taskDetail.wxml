<!-- pages/taskDetail/taskDetail.wxml -->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar">
    <view class="nav-left">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
    </view>
    <view class="nav-title">ä»»åŠ¡è¯¦æƒ…</view>
    <view class="nav-right"></view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-state" wx:if="{{hasError}}">
    <view class="error-content">
      <text class="error-icon">âš ï¸</text>
      <text class="error-title">åŠ è½½å¤±è´¥</text>
      <text class="error-desc">{{errorMessage || 'æ— æ³•åŠ è½½ä»»åŠ¡è¯¦æƒ…'}}</text>
      <text class="error-taskid" wx:if="{{taskId}}">ä»»åŠ¡ID: {{taskId}}</text>
      <button class="retry-btn" bindtap="retryLoad">é‡è¯•åŠ è½½</button>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{isLoading && !hasError}}">
    <view class="loading-content">
      <text class="loading-icon">â³</text>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- æ­£å¸¸å†…å®¹ -->
  <scroll-view class="content-scroll" scroll-y="true" wx:if="{{!isLoading && !hasError}}">
    <!-- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <view class="task-basic-card">
      <view class="task-header-section">
        <text class="task-title-main">{{task.title}}</text>
        <view class="priority-badge-main priority-{{task.priority}}">
          P{{task.priority}}
        </view>
      </view>

      <view class="task-meta-grid">
        <view class="meta-item">
          <text class="meta-icon">â±ï¸</text>
          <view class="meta-content">
            <text class="meta-label">ä»»åŠ¡æ—¶é•¿</text>
            <text class="meta-value">{{task.duration}}åˆ†é’Ÿ</text>
          </view>
        </view>

        <view class="meta-item">
          <text class="meta-icon">ğŸ“…</text>
          <view class="meta-content">
            <text class="meta-label">è®¡åˆ’æ—¥æœŸ</text>
            <text class="meta-value">{{task.date}}</text>
          </view>
        </view>

        <view class="meta-item">
          <text class="meta-icon">ğŸ•’</text>
          <view class="meta-content">
            <text class="meta-label">å®‰æ’æ—¶é—´</text>
            <text class="meta-value" wx:if="{{task.scheduled_start && task.scheduled_end}}">
              {{task.scheduled_start}} - {{task.scheduled_end}}
            </text>
            <text class="meta-value no-schedule" wx:else>æœªå®‰æ’</text>
          </view>
        </view>

        <view class="meta-item">
          <text class="meta-icon">ğŸ“Š</text>
          <view class="meta-content">
            <text class="meta-label">ä»»åŠ¡çŠ¶æ€</text>
            <text class="meta-value status-{{task.status}}">
              {{task.status === 'done' ? 'å·²å®Œæˆ' : task.status === 'in_progress' ? 'è¿›è¡Œä¸­' : 'å¾…å¼€å§‹'}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´å®‰æ’ä¿¡æ¯ -->
    <view class="schedule-card">
      <view class="card-header">
        <text class="card-title">æ—¶é—´ä¿¡æ¯</text>
      </view>
      <view class="schedule-content">
        <view class="schedule-item">
          <text class="schedule-label">åˆ›å»ºæ—¶é—´</text>
          <text class="schedule-value">{{formattedTime.created_at || '--'}}</text>
        </view>
        <view class="schedule-item" wx:if="{{task.completed_at}}">
          <text class="schedule-label">å®Œæˆæ—¶é—´</text>
          <text class="schedule-value">{{formattedTime.completed_at || '--'}}</text>
        </view>
        <view class="schedule-item">
          <text class="schedule-label">æ›´æ–°æ—¶é—´</text>
          <text class="schedule-value">{{formattedTime.updated_at || '--'}}</text>
        </view>
      </view>
    </view>

    <!-- ä»»åŠ¡æè¿° -->
    <view class="description-card" wx:if="{{task.description}}">
      <view class="card-header">
        <text class="card-title">ä»»åŠ¡æè¿°</text>
      </view>
      <view class="description-content">
        <text class="description-text">{{task.description}}</text>
      </view>
    </view>

    <!-- å®ŒæˆçŠ¶æ€æç¤º -->
    <view class="completion-banner" wx:if="{{task.status === 'done'}}">
      <text class="completion-icon">ğŸ‰</text>
      <view class="completion-text">
        <text class="completion-title">ä»»åŠ¡å·²å®Œæˆï¼</text>
        <text class="completion-subtitle">ç»§ç»­ä¿æŒä¼˜ç§€çš„è¡¨ç°ï¼</text>
      </view>
    </view>
  </scroll-view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ -->
  <view class="action-section" wx:if="{{!isLoading && !hasError}}">
    <button class="action-btn primary" bindtap="toggleTaskStatus">
      <text class="btn-icon">{{task.status === 'done' ? 'â†»' : 'âœ“'}}</text>
      <text class="btn-text">{{task.status === 'done' ? 'æ¢å¤ä»»åŠ¡' : 'æ ‡è®°å®Œæˆ'}}</text>
    </button>

    <button class="action-btn outline" bindtap="editTask">
      <text class="btn-icon">âœï¸</text>
      <text class="btn-text">ç¼–è¾‘ä»»åŠ¡</text>
    </button>

    <button class="action-btn secondary" bindtap="goToChat" wx:if="{{task.status !== 'done'}}">
      <text class="btn-icon">ğŸ¤–</text>
      <text class="btn-text">AIåè°ƒ</text>
    </button>
  </view>
</view>